<!DOCTYPE html>
<html>
<head>
    <title>Webhookè¯¦æƒ… #{{ webhook.id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/canary-input.css') }}">
    <style>
        .json-viewer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .header-table {
            font-size: 0.9em;
        }
        .section-title {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 15px;
            margin-top: 25px;
        }
        .badge-method {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .back-link {
            text-decoration: none;
            color: #007bff;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .data-section {
            position: relative;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding-top: 40px;
        }
        .data-section-title {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #007bff;
            color: white;
            padding: 5px 10px;
            font-size: 0.85em;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('main.view_webhooks') }}" class="back-link">â† è¿”å›åˆ—è¡¨</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                ğŸ£ Webhookè¯¦æƒ… #{{ webhook.id }}
                <span class="badge badge-method bg-{{ 'success' if webhook.method == 'GET' else 'light text-dark' }} ms-2">
                    {{ webhook.method }}
                </span>
            </h4>
        </div>
        <div class="card-body">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm header-table">
                        <tr>
                            <td><strong>æ¥æ”¶æ—¶é—´:</strong></td>
                            <td>{{ webhook.timestamp }}</td>
                        </tr>
                        <tr>
                            <td><strong>æ—¶é—´æˆ³:</strong></td>
                            <td>{{ "%.3f"|format(webhook.timestamp_unix) }}</td>
                        </tr>
                        <tr>
                            <td><strong>è¯·æ±‚URL:</strong></td>
                            <td style="word-break: break-all;">{{ webhook.url }}</td>
                        </tr>
                        <tr>
                            <td><strong>è¿œç¨‹åœ°å€:</strong></td>
                            <td>{{ webhook.remote_addr }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm header-table">
                        <tr>
                            <td><strong>Content-Type:</strong></td>
                            <td>{{ webhook.content_type or 'æœªæŒ‡å®š' }}</td>
                        </tr>
                        <tr>
                            <td><strong>User-Agent:</strong></td>
                            <td style="word-break: break-all;">{{ webhook.user_agent or 'æœªçŸ¥' }}</td>
                        </tr>
                        <tr>
                            <td><strong>æ•°æ®å¤§å°:</strong></td>
                            <td>{{ webhook.raw_data|length }} å­—èŠ‚</td>
                        </tr>
                        <tr>
                            <td><strong>Headeræ•°é‡:</strong></td>
                            <td>{{ webhook.headers|length }} ä¸ª</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- è¯·æ±‚å¤´ -->
            <h5 class="section-title">ğŸ“‹ è¯·æ±‚å¤´ (Headers)</h5>
            <div class="data-section">
                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('headers')">
                    ğŸ“‹ å¤åˆ¶
                </button>
                <div class="json-viewer" id="headers">
{{ webhook.headers | tojson(indent=2) }}
                </div>
            </div>

            <!-- æŸ¥è¯¢å‚æ•° -->
            {% if webhook.query_params %}
            <h5 class="section-title">ğŸ” æŸ¥è¯¢å‚æ•° (Query Parameters)</h5>
            <div class="data-section">
                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('query-params')">
                    ğŸ“‹ å¤åˆ¶
                </button>
                <div class="json-viewer" id="query-params">
{{ webhook.query_params | tojson(indent=2) }}
                </div>
            </div>
            {% endif %}

            <!-- è¡¨å•æ•°æ® -->
            {% if webhook.form_data %}
            <h5 class="section-title">ğŸ“ è¡¨å•æ•°æ® (Form Data)</h5>
            <div class="data-section">
                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('form-data')">
                    ğŸ“‹ å¤åˆ¶
                </button>
                <div class="json-viewer" id="form-data">
{{ webhook.form_data | tojson(indent=2) }}
                </div>
            </div>
            {% endif %}

            <!-- è§£æåçš„JSONæ•°æ® -->
            {% if webhook.data %}
            <h5 class="section-title">ğŸ“Š è§£ææ•°æ® (JSON)</h5>
            <div class="data-section">
                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('parsed-data')">
                    ğŸ“‹ å¤åˆ¶
                </button>
                <div class="json-viewer" id="parsed-data">
{{ webhook.data | tojson(indent=2) }}
                </div>
            </div>
            {% endif %}

            <!-- åŸå§‹æ•°æ® -->
            <h5 class="section-title">ğŸ“„ åŸå§‹æ•°æ® (Raw Data)</h5>
            <div class="data-section">
                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('raw-data')">
                    ğŸ“‹ å¤åˆ¶
                </button>
                <div class="json-viewer" id="raw-data">{{ webhook.raw_data }}</div>
            </div>

            <!-- æµ‹è¯•ç”¨ä¾‹ -->
            <h5 class="section-title">ğŸ§ª æµ‹è¯•ç”¨ä¾‹ (cURL)</h5>
            <div class="data-section">
                <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('curl-command')">
                    ğŸ“‹ å¤åˆ¶
                </button>
                <div class="json-viewer" id="curl-command">
curl -X {{ webhook.method }} "{{ webhook.url }}" \
{% for key, value in webhook.headers.items() if key not in ['Host', 'Content-Length'] %}
  -H "{{ key }}: {{ value }}" \
{% endfor %}
{% if webhook.method == 'POST' and webhook.raw_data %}
  -d '{{ webhook.raw_data.replace("'", "'\"'\"'") }}'
{% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3 text-center">
        <a href="{{ url_for('main.view_webhooks') }}" class="btn btn-outline-primary">â† è¿”å›åˆ—è¡¨</a>
        <button class="btn btn-outline-secondary ms-2" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent || element.innerText;

    navigator.clipboard.writeText(text).then(() => {
        showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(err => {
        // é™çº§æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
</body>
</html>