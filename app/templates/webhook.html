<!DOCTYPE html>
<html>
<head>
    <title>Webhookæ•°æ®æ¥æ”¶ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/canary-input.css') }}">
    <style>
        .webhook-card {
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        .webhook-card:hover {
            border-left-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .timestamp {
            color: #6c757d;
            font-size: 0.9em;
        }
        .method-badge {
            font-size: 0.8em;
        }
        .data-preview {
            max-height: 100px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .header-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="header-info">
        <h2>ğŸ£ Webhookæ•°æ®æ¥æ”¶ä¸­å¿ƒ</h2>
        <p class="mb-0">
            <strong>æ¥æ”¶åœ°å€:</strong>
            <code>{{ request.host_url }}webhook</code>
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyWebhookUrl()">ğŸ“‹ å¤åˆ¶</button>
        </p>
        <p class="mb-0 text-muted mt-1">æ”¯æŒæ¥æ”¶ä»»æ„æ ¼å¼çš„POST/GETæ•°æ®ï¼Œè‡ªåŠ¨è§£æå¹¶ç¾åŒ–æ˜¾ç¤º</p>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center">
                <h5>æ¥æ”¶å†å² ({{ webhooks|length }} æ¡è®°å½•)</h5>
            </div>
        </div>
        <div class="col-md-6 text-end">
            {% if webhooks %}
            <button class="btn btn-outline-danger btn-sm" onclick="clearWebhooks()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="refreshPage()">ğŸ”„ åˆ·æ–°</button>
            {% endif %}
        </div>
    </div>

    {% if webhooks %}
    <div class="webhook-list">
        {% for webhook in webhooks %}
        <div class="card webhook-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge method-badge bg-{{ 'success' if webhook.method == 'GET' else 'primary' }} me-2">
                                {{ webhook.method }}
                            </span>
                            <span class="badge bg-secondary me-2">{{ webhook.content_type or 'unknown' }}</span>
                            <span class="timestamp me-3">
                                ğŸ“… {{ webhook.timestamp }}
                            </span>
                            <span class="badge bg-info">
                                ğŸŒ {{ webhook.remote_addr }}
                            </span>
                        </div>

                        {% if webhook.data %}
                        <div class="data-preview mb-2">
                            <strong>æ•°æ®é¢„è§ˆ:</strong><br>
                            {{ webhook.raw_data[:200] }}{% if webhook.raw_data|length > 200 %}...{% endif %}
                        </div>
                        {% endif %}

                        <div class="text-muted small">
                            {% if webhook.query_params %}
                            <span class="me-3">ğŸ“‹ æŸ¥è¯¢å‚æ•°: {{ webhook.query_params|length }} ä¸ª</span>
                            {% endif %}
                            {% if webhook.form_data %}
                            <span class="me-3">ğŸ“ è¡¨å•æ•°æ®: {{ webhook.form_data|length }} ä¸ª</span>
                            {% endif %}
                            <span>ğŸ¤– {{ webhook.user_agent[:30] }}{% if webhook.user_agent|length > 30 %}...{% endif %}</span>
                        </div>
                    </div>

                    <div class="col-md-4 text-end">
                        <a href="{{ url_for('main.view_webhook_detail', webhook_id=webhook.id) }}"
                           class="btn btn-outline-primary btn-sm">ğŸ” æŸ¥çœ‹è¯¦æƒ…</a>
                        <button class="btn btn-outline-secondary btn-sm ms-2"
                                onclick="copyData({{ webhook.id }})">ğŸ“‹ å¤åˆ¶æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h4>ğŸ“­ æš‚æ— æ¥æ”¶æ•°æ®</h4>
        <p>å‘ä»¥ä¸‹åœ°å€å‘é€æ•°æ®å³å¯å¼€å§‹æµ‹è¯•:</p>
        <div class="mt-3">
            <code style="background: #f8f9fa; padding: 15px; border-radius: 5px; display: inline-block;">
                curl -X POST {{ request.host_url }}webhook \<br>
                &nbsp;&nbsp;&nbsp;&nbsp;-H "Content-Type: application/json" \<br>
                &nbsp;&nbsp;&nbsp;&nbsp;-d '{"test": "hello world", "timestamp": "2024-01-01T00:00:00Z"}'
            </code>
        </div>
        <p class="mt-3 text-muted">
            æ”¯æŒ GET/POST è¯·æ±‚ï¼Œè‡ªåŠ¨è¯†åˆ« JSONã€è¡¨å•æ•°æ®ç­‰æ ¼å¼
        </p>
    </div>
    {% endif %}
</div>

<script>
function copyWebhookUrl() {
    const url = '{{ request.host_url }}webhook';
    navigator.clipboard.writeText(url).then(() => {
        showToast('Webhookåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    });
}

function copyData(webhookId) {
    fetch('/webhook/' + webhookId)
        .then(response => response.json())
        .then(data => {
            const text = JSON.stringify(data, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                showToast('æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        })
        .catch(error => {
            showToast('å¤åˆ¶å¤±è´¥', 'error');
        });
}

function clearWebhooks() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
        fetch('/webhook/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('å†å²è®°å½•å·²æ¸…ç©º', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('æ¸…ç©ºå¤±è´¥', 'error');
                }
            })
            .catch(error => {
                showToast('æ¸…ç©ºå¤±è´¥', 'error');
            });
    }
}

function refreshPage() {
    location.reload();
}

function showToast(message, type) {
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„toastæç¤º
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
</body>
</html>