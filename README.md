# Canary Controller

ä¸€ä¸ªç”¨äºç®¡ç† Kubernetes Ingress Canary éƒ¨ç½²çš„ Web æ§åˆ¶é¢æ¿ã€‚

## æ¦‚è¿°

Canary Controller æ˜¯ä¸€ä¸ªåŸºäº Flask çš„ Web åº”ç”¨ç¨‹åºï¼Œæä¾›ç›´è§‚çš„ç•Œé¢æ¥ç®¡ç†å’Œé…ç½® Kubernetes Ingress çš„ Canary éƒ¨ç½²ã€‚å®ƒæ”¯æŒå¤šç§ Canary ç­–ç•¥ï¼ŒåŒ…æ‹¬åŸºäºæƒé‡ã€è¯·æ±‚å¤´å’Œ Cookie çš„æµé‡åˆ†å‰²ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸŒ **ç°ä»£åŒ–Webç•Œé¢** - å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ¡Œé¢å’Œç§»åŠ¨ç«¯
- ğŸ”„ **æ™ºèƒ½è¾“å…¥æ¡†** - ç‚¹å‡»å±•å¼€æ”¯æŒé•¿æ–‡æœ¬ç¼–è¾‘ï¼Œå®æ—¶å­—ç¬¦è®¡æ•°
- ğŸ”” **ä¼˜é›…çš„é€šçŸ¥ç³»ç»Ÿ** - Toastæç¤ºæ›¿ä»£ä¼ ç»Ÿalertï¼Œç”¨æˆ·ä½“éªŒå‹å¥½
- ğŸ”’ **å¹¶å‘æ§åˆ¶** - ç”¨æˆ·çº§åˆ«çš„é”æœºåˆ¶é˜²æ­¢å¹¶å‘ä¿®æ”¹
- ğŸ¯ **å¤šç§ç­–ç•¥æ”¯æŒ** - æ”¯æŒæƒé‡ã€è¯·æ±‚å¤´ã€Cookie ç­‰ Canary ç­–ç•¥
- âš¡ **Ajaxæ“ä½œ** - æ— åˆ·æ–°è¡¨å•æäº¤ï¼Œå®æ—¶åé¦ˆ
- ğŸ¹ **å®æ—¶éªŒè¯** - å‰ç«¯è¡¨å•éªŒè¯ï¼Œå³æ—¶é”™è¯¯æç¤º
- âŒ¨ï¸ **å¿«æ·é”®æ”¯æŒ** - Enterä¿å­˜ï¼ŒEscapeå–æ¶ˆ
- ğŸ“± **å“åº”å¼è®¾è®¡** - ç§»åŠ¨ç«¯å‹å¥½çš„äº¤äº’ä½“éªŒ

## æ”¯æŒçš„ Canary ç­–ç•¥

### 1. æƒé‡åˆ†æµ (Weight-based)
- é€šè¿‡ `nginx.ingress.kubernetes.io/canary-weight` æ³¨è§£è®¾ç½®
- å–å€¼èŒƒå›´ï¼š0-100ï¼Œè¡¨ç¤ºæµé‡ç™¾åˆ†æ¯”

### 2. è¯·æ±‚å¤´åˆ†æµ (Header-based)
- `nginx.ingress.kubernetes.io/canary-by-header` - å¯ç”¨åŸºäºè¯·æ±‚å¤´çš„åˆ†æµ
- `nginx.ingress.kubernetes.io/canary-by-header-value` - åŒ¹é…ç‰¹å®šè¯·æ±‚å¤´å€¼
- `nginx.ingress.kubernetes.io/canary-by-header-pattern` - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¯·æ±‚å¤´

### 3. Cookie åˆ†æµ (Cookie-based)
- é€šè¿‡ `nginx.ingress.kubernetes.io/canary-by-cookie` æ³¨è§£è®¾ç½®
- åŸºäºç‰¹å®š Cookie å€¼è¿›è¡Œåˆ†æµ

## é¡¹ç›®ç»“æ„

```
canary-controller/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py          # Flask åº”ç”¨å·¥å‚
â”‚   â”œâ”€â”€ routes.py            # ä¸»è¦è·¯ç”±å’Œä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ kubectl_utils.py     # Kubernetes API å·¥å…·
â”‚   â”œâ”€â”€ forms.py             # è¡¨å•å®šä¹‰
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â””â”€â”€ index.html       # ä¸»é¡µé¢æ¨¡æ¿
â”‚   â””â”€â”€ static/
â”‚       â””â”€â”€ js/
â”‚           â””â”€â”€ validate.js  # å‰ç«¯è¡¨å•éªŒè¯
â”œâ”€â”€ config.py                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ run.py                   # åº”ç”¨å…¥å£
â””â”€â”€ README.md               # é¡¹ç›®æ–‡æ¡£
```

## æ ¸å¿ƒæ¨¡å—

### 1. åº”ç”¨å…¥å£ (`run.py`)
åº”ç”¨ç¨‹åºçš„å¯åŠ¨å…¥å£ï¼Œåˆ›å»ºå¹¶è¿è¡Œ Flask åº”ç”¨ã€‚

```python
from app import create_app

app = create_app()

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8888)
```

### 2. è·¯ç”±æ§åˆ¶ (`app/routes.py`)
ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘å’Œ API ç«¯ç‚¹ï¼š

- `GET /` - ä¸»é¡µé¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰ Canary Ingress
- `GET /set` - æ›´æ–° Ingress æ³¨è§£
- `POST /lock` - é”å®š Ingress é˜²æ­¢å¹¶å‘ä¿®æ”¹
- `POST /unlock` - è§£é” Ingress

**å…³é”®ç‰¹æ€§ï¼š**
- ä½¿ç”¨å…¨å±€é”è¡¨ç®¡ç†å¹¶å‘è®¿é—®
- åŸºäºç”¨æˆ·é‚®ç®±çš„èº«ä»½è¯†åˆ«
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸé”ï¼ˆ24å°æ—¶TTLï¼‰

### 3. Kubernetes å·¥å…· (`app/kubectl_utils.py`)
å°è£… Kubernetes API æ“ä½œï¼š

- `get_ingresses()` - è·å–æ‰€æœ‰ Canary Ingress
- `set_ingress_annotations()` - æ›´æ–° Ingress æ³¨è§£

**é…ç½®åŠ è½½ä¼˜å…ˆçº§ï¼š**
1. In-cluster é…ç½®ï¼ˆé›†ç¾¤å†…è¿è¡Œæ—¶ï¼‰
2. æœ¬åœ° kubeconfig æ–‡ä»¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

### 4. å‰ç«¯éªŒè¯ (`app/static/js/validate.js`)
å®¢æˆ·ç«¯è¡¨å•éªŒè¯é€»è¾‘ï¼š

- éªŒè¯æƒé‡èŒƒå›´ï¼ˆ0-100ï¼‰
- æ£€æŸ¥è¯·æ±‚å¤´é…ç½®å†²çª
- æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼éªŒè¯

## å®‰è£…å’Œéƒ¨ç½²

### å‰ç½®è¦æ±‚

- Python 3.7+
- Kubernetes é›†ç¾¤
- NGINX Ingress Controller
- kubectl é…ç½®

### ä¾èµ–å®‰è£…

```bash
pip install flask kubernetes
```

### é…ç½®æ–‡ä»¶

ç¡®ä¿ Kubernetes é…ç½®æ–‡ä»¶è·¯å¾„æ­£ç¡®ï¼š
- é»˜è®¤è·¯å¾„ï¼š`/Users/admin/.kube/config-devops`
- å¯åœ¨ `app/kubectl_utils.py` ä¸­ä¿®æ”¹

### è¿è¡Œåº”ç”¨

```bash
python run.py
```

åº”ç”¨å°†åœ¨ `http://0.0.0.0:8888` å¯åŠ¨ã€‚

## API æ–‡æ¡£

### è®¤è¯

åº”ç”¨é€šè¿‡è¯·æ±‚å¤´ `X-Auth-Request-Email` è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œæ”¯æŒï¼š

- é›†ç¾¤å†… OIDC è®¤è¯é›†æˆ
- åŒ¿åè®¿é—®ï¼ˆç”¨æˆ·åä¸º "anonymous"ï¼‰

### ç«¯ç‚¹è¯¦æƒ…

#### GET /
**æè¿°**ï¼šè·å–ä¸»é¡µé¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰ Canary Ingress

**å“åº”**ï¼šHTML é¡µé¢ï¼ŒåŒ…å«ï¼š
- Ingress åˆ—è¡¨è¡¨æ ¼
- å½“å‰é…ç½®çš„æ³¨è§£ä¿¡æ¯
- é”çŠ¶æ€æ˜¾ç¤º

#### GET /set
**æè¿°**ï¼šæ›´æ–° Ingress çš„ Canary æ³¨è§£

**å‚æ•°**ï¼š
- `namespace` (string) - Ingress å‘½åç©ºé—´
- `ingress` (string) - Ingress åç§°
- `weight` (string, å¯é€‰) - æƒé‡å€¼ (0-100)
- `header` (string, å¯é€‰) - è¯·æ±‚å¤´åç§°
- `header_value` (string, å¯é€‰) - è¯·æ±‚å¤´åŒ¹é…å€¼
- `header_pattern` (string, å¯é€‰) - è¯·æ±‚å¤´æ­£åˆ™è¡¨è¾¾å¼
- `cookie` (string, å¯é€‰) - Cookie åç§°

**å“åº”**ï¼šé‡å®šå‘åˆ°ä¸»é¡µé¢

**é”™è¯¯**ï¼š
- `403 Forbidden` - æœªé”å®šæˆ–è¢«å…¶ä»–ç”¨æˆ·é”å®š

#### POST /lock
**æè¿°**ï¼šé”å®š Ingress ä»¥è¿›è¡Œä¿®æ”¹

**å‚æ•°**ï¼š
- `namespace` (string) - Ingress å‘½åç©ºé—´
- `ingress` (string) - Ingress åç§°

**å“åº”**ï¼š
```json
{
  "status": "locked"
}
```

**é”™è¯¯**ï¼š
- `403 Forbidden` - å·²è¢«å…¶ä»–ç”¨æˆ·é”å®š

#### POST /unlock
**æè¿°**ï¼šè§£é” Ingress

**å‚æ•°**ï¼š
- `namespace` (string) - Ingress å‘½åç©ºé—´
- `ingress` (string) - Ingress åç§°

**å“åº”**ï¼š
```json
{
  "status": "unlocked"
}
```

## å®‰å…¨è€ƒè™‘

1. **é”æœºåˆ¶**ï¼šé˜²æ­¢å¤šç”¨æˆ·åŒæ—¶ä¿®æ”¹åŒä¸€ Ingress
2. **ç”¨æˆ·èº«ä»½**ï¼šåŸºäºé‚®ç®±çš„ç”¨æˆ·è¯†åˆ«
3. **è¾“å…¥éªŒè¯**ï¼šå‰åç«¯åŒé‡éªŒè¯ç¡®ä¿é…ç½®å®‰å…¨
4. **æƒé™æ§åˆ¶**ï¼šä¾èµ– Kubernetes RBAC è¿›è¡Œæƒé™ç®¡ç†

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ— æ³•è¿æ¥ Kubernetes**
   - æ£€æŸ¥ kubeconfig æ–‡ä»¶è·¯å¾„
   - éªŒè¯é›†ç¾¤è¿æ¥æƒé™

2. **é¡µé¢æ˜¾ç¤º "No canary ingresses found"**
   - ç¡®ä¿æœ‰å¸¦æœ‰ `nginx.ingress.kubernetes.io/canary: "true"` æ³¨è§£çš„ Ingress
   - æ£€æŸ¥ NGINX Ingress Controller çŠ¶æ€

3. **æ— æ³•ä¿®æ”¹ Ingress**
   - ç¡®ä¿å·²é”å®šå¯¹åº”çš„ Ingress
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç”¨æˆ·å·²é”å®š

### æ—¥å¿—æŸ¥çœ‹

åº”ç”¨æ—¥å¿—ä¼šæ˜¾ç¤ºå…³é”®æ“ä½œä¿¡æ¯ï¼š
- ç”¨æˆ·æ“ä½œè®°å½•
- é”è·å–/é‡Šæ”¾
- Kubernetes API è°ƒç”¨

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚